<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="enchant.min.js"></script>
</head>

<body>
    <script>
        enchant(); //おまじない
        window.onload = function () {
            console.log(document.body.scrollWidth, window.innerHeight);
            //陽性、陰性の数
            var negative_count = 300; //陰性　
            var positive_count = 10; //陽性

            //ゲームの幅と高さ
            var width = document.body.scrollWidth;
            var height = window.innerHeight;
            var game = new Game(width, height); //Gameオブジェクトを生成

            game.preload("icon0.png"); //画像のロード指定
            game.rootScene.backgroundColor = "#f3f3f3"; //背景色

            game.onload = function () {
                //キーバインド
                game.keybind('Q'.charCodeAt(0), 'q');
                game.keybind('W'.charCodeAt(0), 'w');

                //画像生成クラス
                MakeImage = Class.create(Sprite, {
                    initialize: function (x, y, w, angle, myno, status) {
                        Sprite.call(this, w, w);
                        this.image = game.assets["icon0.png"];

                        // 画像の選択
                        if (status == "negative") {
                            //negative
                            this.frame = 10; //画像の中のフレームの数字
                        } else {
                            //positive
                            this.frame = 11; //画像の中のフレームの数字
                        }
                        this.status = status; // ステータス

                        this.x = x;
                        this.y = y;
                        this.w = w; // 直径
                        this.angle = angle; // 向いている方向(角度)
                        this.r = 10; // 移動したい距離（スピード）
                        this.myno = myno; // 自分の番号

                        var infectivity = 0.3;//max1
                        var immunity = 1;//max0(感染しない)

                        // 画面更新のたびに実行する処理
                        this.addEventListener(Event.ENTER_FRAME, function () {
                            // 角度で進む
                            this.rad = this.angle * (Math.PI / 180.0);
                            this.dx = Math.cos(this.rad) * this.r;
                            this.dy = Math.sin(this.rad) * this.r;
                            this.x = this.x + this.dx;
                            this.y = this.y + this.dy;

                            // 端についたら跳ね返る（TODO: 一番端の処理が甘くややバグってる）
                            // 横端
                            if (this.x < 10 + this.w * 2) {
                                this.x = 10 + this.w * 2 + 1;
                                this.angle = 180 - this.angle;
                            }
                            if (this.x > width - (10 + this.w * 2)) {
                                this.x = width - (10 + this.w * 2 + 1);
                                this.angle = 180 - this.angle;
                            }
                            if (this.y < 10 + this.w * 2) {
                                this.angle = 360 - this.angle;
                                this.y = 10 + this.w * 2 + 1;
                            }
                            if (this.y > height - (10 + this.w * 2)) {
                                this.angle = 360 - this.angle;
                                this.y = height - (10 + this.w * 2 + 1);
                            }

                            // 衝突判定
                            var hits = this.intersect(MakeImage);

                            // 衝突相手が自分の番号では無く、自分がnegativeで相手がpositiveなら
                            if (hits[0].myno != this.myno && hits[1].status == "positive" && hits[0].status == "negative") {
                                //デバッグ用
                                console.log("衝突");
                                //最終的な感染力の計算(％)
                                var random = Math.floor(Math.random() * (99 - 0 + 1) + 0) * 0.01;//0~99ランダムピック
                                var infection_per = infectivity * immunity;
                                if (infection_per >= random) {
                                    //画像の変更
                                    hits[0].frame = 11;
                                    //ステータスの変更
                                    hits[0].status = "positive";
                                    //数の変更
                                    positive_count++;
                                    negative_count--;
                                }


                            }

                            this.ontouchend = function () {
                                //タッチされたら
                                console.log("いたい");
                                this.x = 0;
                                this.y = 0;
                            };

                            if (game.input.q) {
                                immunity = 0.1
                                console.log(immunity)
                            };

                            if (game.input.w) {
                                infectivity = infectivity * 1.95
                                console.log(infectivity)
                            };
                        });
                    },
                });

                var angle = () => { return Math.floor(Math.random() * (360 - 0 + 1) + 0); }
                var xRandom = () => { return Math.floor(Math.random() * (width - 0 + 1) + 0); }
                var yRandom = () => { return Math.floor(Math.random() * (height - 0 + 1) + 0); }

                // negativeの生成
                for (var i = 0; i < negative_count; i++) {
                    // 乱数
                    var rand = Math.floor(Math.random() * 50);
                    // 画像を出す
                    // MakeImage(x, y, w, angle, myno, status)
                    var image = new MakeImage(xRandom(), yRandom(), 16, angle(), i, "negative");
                    // シーンに登録
                    game.rootScene.addChild(image);
                }

                // positiveの生成
                for (var i = 0; i < positive_count; i++) {
                    // 乱数
                    var rand = Math.floor(Math.random() * 50);
                    // 画像を出す
                    // MakeImage(x, y, w, angle, myno, status)
                    var image = new MakeImage(xRandom(), yRandom(), 16, angle(), i, "positive");
                    // シーンに登録
                    game.rootScene.addChild(image);
                }

                // シーンの定期処理
                game.rootScene.addEventListener("enterframe", function () {
                    // 陰性、陽性の数
                    console.log("positive:" + positive_count + " negative:" + negative_count);
                    // 陰性が0になったら
                    if (negative_count == 0) {
                        game.rootScene.backgroundColor = "#ffa49d"; //背景色
                        game.stop(); //ゲームを止める
                    }
                });
            };
            game.start(); //ゲーム開始
        };
    </script>
</body>
<style>
    *{
        margin: 0;
        padding: 0;
    }
</style>

</html>
